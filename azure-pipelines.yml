# azure-pipelines-order-service.yml
trigger:
- main

variables:
  # CONFIGURACIÓN DE TU ENTORNO
  acrName: 'microsdnhubacr' 
  azureServiceConnection: 'Azure-Conn-AKS-DAVID' 
  aksResourceGroup: 'RG-Microservicios-NET' 
  aksClusterName: 'aks-dotnethub' 

  # CONFIGURACIÓN DEL SERVICIO (Order Service)
  imageRepository: 'orderservice'
  dockerfilePath: 'Orders.Api/Dockerfile'
  deploymentYamlPath: 'aks-deployment-order.yaml' 

# ----------------------------------------------------
# 1. Etapa de CI: Construir y Subir Imagen a ACR
# ----------------------------------------------------
stages:
- stage: BuildAndPush
  displayName: 1. Build and Push Docker Image
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    
    # 1. Login y Push a ACR
    - task: Docker@2
      displayName: Build and push image to ACR
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(azureServiceConnection) 
        tags: |
          $(Build.BuildId)

# ----------------------------------------------------
# 2. Etapa de CD: Desplegar a AKS
# ----------------------------------------------------
- stage: Deploy
  displayName: 2. Deploy to AKS
  dependsOn: BuildAndPush
  jobs:
  - deployment: DeployJob
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'AKS-Deployment-Env'
    strategy:
      runOnce:
        deploy:
          steps:
          
          # 2. Aplicar Manifiesto de Kubernetes
          - task: KubernetesManifest@1
            displayName: Deploy to AKS
            inputs:
              action: 'deploy'
              connectionType: 'azureResourceManager'
              # Usamos el endpoint de la conexión de servicio (sustituye azureSubscription)
              azureSubscriptionEndpoint: $(azureServiceConnection) 
              # Usamos el nombre del clúster AKS (sustituye resourceGroupName y clusterName)
              kubernetesCluster: $(aksClusterName) 
              
              manifests: |
                $(System.DefaultWorkingDirectory)/$(deploymentYamlPath)
              
              containers: |
                $(acrName).azurecr.io/$(imageRepository):$(Build.BuildId)
              
              imagePullSecrets: 'azurecrsecret'